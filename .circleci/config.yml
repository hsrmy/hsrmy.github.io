version: 2
jobs:
  build:
    docker:
      - image: cibuilds/hugo:latest
    working_directory: ~/hugo
    steps:
      # working_directoryにリポジトリをコピー
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "91:db:bd:a8:04:a0:13:5a:2c:74:5f:a9:18:fc:82:74"
      - run:
        # 環境を最新に
          name: Update enviroment
          command: apt -y update && apt -y install git
      - run:
        # 作業ブランチをsourceに切り替え
          name: Checkout branch
          command: git checkout source
      - run:
        # submoduleにしているテーマのアップデート
          name: Update theme
          command: git submodule update -i
      - run:
          # 記事の作成
          name: Create ariticle
          command: hugo
      - run:
          name: Add .ssh/known_hosts
          command: >-
            echo 'github.com,52.192.72.89 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==' > ~/.ssh/known_hosts
      - run:
        # tmpフォルダにmasterブランチをclone
          name: Clone master into tmp
          command: mkdir -p tmp && cd tmp && git clone git@github.com:hsrmy/hsrmy.github.io.git
      - run:
        # 一旦tmp/hsrmy.github.ioの中身を削除
          name: Clean tmp/hsrmy.github.io
          command: rm -rf tmp/hsrmy.github.io/*
      - run:
        # publicの中身をtmp/hsrmy.github.ioの中にコピー
          name: Copy public
          command: cp -fr public/* tmp/hsrmy.github.io/
      - run:
        # Gitの設定
          name: Setting git
          command: git config --global user.name hsrmy && git config --global user.email hsrmy@emradc.xyz
      - run:
        # Githubに反映
          name: Deploy
          command: cd tmp/hsrmy.github.io/ && git fetch && git add . && git commit -m "publish" && git push origin master:test
